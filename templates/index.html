<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>论文抓取与管理平台</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        .log-panel { height: 200px; background-color: #212529; color: #f8f9fa; font-family: monospace; font-size: 0.8rem; overflow-y: auto; padding: 10px; border-radius: 0 0 .25rem .25rem; }
        .log-panel .log-entry { white-space: pre-wrap; word-break: break-all; }
        #papers-table-body a { text-decoration: none; }
        #papers-table-body a:hover { text-decoration: underline; }
        .status-badge { min-width: 80px; text-align: center; }
        .category-checkbox-group { max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; padding: 10px; border-radius: .25rem; }
        .category-checkbox-group .form-check { margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <header class="text-center mb-4">
            <h1><i class="bi bi-robot"></i> 论文抓取与管理平台</h1>
            <p class="lead text-muted">一个现代化的科研论文自动化工具</p>
        </header>

        <div class="row">
            <!-- 左侧控制栏 -->
            <div class="col-lg-4">
                <!-- 控制面板 -->
                <div class="card mb-4">
                    <div class="card-header fw-bold"><i class="bi bi-gear-fill"></i> 控制面板</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="mode-select" class="form-label">抓取模式</label>
                            <select id="mode-select" class="form-select">
                                <option value="category">按分类 (推荐)</option>
                                <option value="keyword">按关键词</option>
                            </select>
                        </div>
                        <div class="d-grid gap-2">
                            <button id="start-btn" class="btn btn-primary"><i class="bi bi-play-fill"></i> 开始抓取</button>
                            <button id="stop-btn" class="btn btn-danger" disabled><i class="bi bi-stop-fill"></i> 停止抓取</button>
                        </div>
                    </div>
                </div>

                <!-- 参数配置 -->
                <div class="card mb-4" id="category-selection-card">
                    <div class="card-header fw-bold" id="category-selection-heading">
                        <button class="btn btn-link text-decoration-none text-dark w-100 text-start d-flex justify-content-between align-items-center" type="button" data-bs-toggle="collapse" data-bs-target="#category-selection-collapse" aria-expanded="true" aria-controls="category-selection-collapse">
                            <i class="bi bi-tags-fill"></i> 类别选择
                            <i class="bi bi-chevron-down"></i>
                        </button>
                    </div>
                    <div id="category-selection-collapse" class="collapse show" aria-labelledby="category-selection-heading">
                        <div class="card-body">
                            <div class="mb-3" id="arxiv-cats-group">
                                <label class="form-label">arXiv 分类</label>
                                <div id="arxiv-cats-checkboxes" class="category-checkbox-group">
                                    <!-- arXiv checkboxes will be loaded here -->
                                </div>
                            </div>
                            <div class="mb-3" id="biorxiv-cats-group">
                                <label class="form-label">bioRxiv 分类</label>
                                <div id="biorxiv-cats-checkboxes" class="category-checkbox-group">
                                    <!-- bioRxiv checkboxes will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" id="parameter-config-card">
                    <div class="card-header fw-bold" id="parameters-heading">
                        <button class="btn btn-link text-decoration-none text-dark w-100 text-start d-flex justify-content-between align-items-center" type="button" data-bs-toggle="collapse" data-bs-target="#parameters-collapse" aria-expanded="true" aria-controls="parameters-collapse">
                            <i class="bi bi-sliders"></i> 参数配置
                            <i class="bi bi-chevron-down"></i>
                        </button>
                    </div>
                    <div id="parameters-collapse" class="collapse show" aria-labelledby="parameters-heading">
                        <div class="card-body">
                            <div class="mb-3" id="keywords-group">
                                <label for="keywords-input" class="form-label">关键词 (每行一个)</label>
                                <textarea id="keywords-input" class="form-control" rows="4"></textarea>
                            </div>
                            <div class="mb-3" id="arxiv-max-results-kw-group">
                                <label for="arxiv-max-results-kw-input" class="form-label">arXiv 关键词最大结果数</label>
                                <input type="number" class="form-control" id="arxiv-max-results-kw-input" min="1">
                            </div>
                            <div class="mb-3" id="biorxiv-days-ago-group">
                                <label for="biorxiv-days-ago-input" class="form-label">bioRxiv 关键词抓取天数</label>
                                <input type="number" class="form-control" id="biorxiv-days-ago-input" min="1">
                            </div>
                            <div class="mb-3" id="arxiv-max-results-cat-group">
                                <label for="arxiv-max-results-cat-input" class="form-label">arXiv 分类最大结果数 (每个分类)</label>
                                <input type="number" class="form-control" id="arxiv-max-results-cat-input" min="1" value="50">
                            </div>
                            <div class="mb-3" id="category-fetch-days-ago-group">
                                <label for="category-fetch-days-ago-input" class="form-label">分类抓取天数</label>
                                <input type="number" class="form-control" id="category-fetch-days-ago-input" min="1">
                            </div>
                            <button id="save-config-btn" class="btn btn-success w-100"><i class="bi bi-check-circle"></i> 保存配置</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧状态与结果 -->
            <div class="col-lg-8">
                <!-- 状态与日志 -->
                <div class="card mb-4">
                    <div class="card-header fw-bold"><i class="bi bi-terminal-fill"></i> 状态与日志</div>
                    <div class="card-body p-0">
                        <div class="p-3">
                            <div class="progress" style="height: 25px;">
                                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                        </div>
                        <div id="log-panel" class="log-panel">
                            <div class="log-entry text-muted">等待连接服务器...</div>
                        </div>
                    </div>
                </div>

                <!-- 下载列表 -->
                <div class="card">
                    <div class="card-header fw-bold"><i class="bi bi-journals"></i> 下载列表</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="category-filter-select" class="form-label">按类别筛选</label>
                            <select id="category-filter-select" class="form-select">
                                <option value="">所有类别</option>
                                <!-- Categories will be dynamically loaded here -->
                            </select>
                        </div>
                        <div class="d-flex justify-content-end mb-3"> <!-- New div for buttons -->
                            <button id="delete-selected-btn" class="btn btn-danger btn-sm me-2" disabled><i class="bi bi-trash"></i> 删除选中</button>
                            <button id="delete-all-btn" class="btn btn-danger btn-sm"><i class="bi bi-trash-fill"></i> 删除所有</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th scope="col"><input type="checkbox" id="select-all-papers"></th>
                                        <th scope="col">标题</th>
                                        <th scope="col">作者</th>
                                        <th scope="col">来源</th>
                                        <th scope="col">分类</th>
                                        <th scope="col">日期</th>
                                        <th scope="col">下载/链接</th>
                                    </tr>
                                </thead>
                                <tbody id="papers-table-body">
                                    <!-- 论文条目将通过JS动态插入 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- Custom JS -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const socket = io();

            // --- Global State ---
            let allPapers = []; // To store all fetched papers for filtering

            // --- DOM Elements ---
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const saveConfigBtn = document.getElementById('save-config-btn');
            const modeSelect = document.getElementById('mode-select');
            const logPanel = document.getElementById('log-panel');
            const progressBar = document.getElementById('progress-bar');
            const papersTableBody = document.getElementById('papers-table-body');
            const keywordsInput = document.getElementById('keywords-input');
            const arxivCatsCheckboxes = document.getElementById('arxiv-cats-checkboxes');
            const biorxivCatsCheckboxes = document.getElementById('biorxiv-cats-checkboxes');
            const categoryFilterSelect = document.getElementById('category-filter-select');
            const selectAllPapersCheckbox = document.getElementById('select-all-papers');
            const deleteSelectedBtn = document.getElementById('delete-selected-btn');
            const deleteAllBtn = document.getElementById('delete-all-btn');
            
            // Input groups for toggling visibility
            const keywordsGroup = document.getElementById('keywords-group');
            const arxivCatsGroup = document.getElementById('arxiv-cats-group');
            const biorxivCatsGroup = document.getElementById('biorxiv-cats-group');
            const arxivMaxResultsKwGroup = document.getElementById('arxiv-max-results-kw-group');
            const biorxivDaysAgoGroup = document.getElementById('biorxiv-days-ago-group');
            const arxivMaxResultsCatGroup = document.getElementById('arxiv-max-results-cat-group');
            const categoryFetchDaysAgoGroup = document.getElementById('category-fetch-days-ago-group');

            // --- Helper Functions ---
            const addLog = (message, level = 'info') => {
                const entry = document.createElement('div');
                entry.className = `log-entry text-${level}`;
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logPanel.appendChild(entry);
                logPanel.scrollTop = logPanel.scrollHeight;
            };

            const setProgress = (percentage, text = null) => {
                percentage = Math.max(0, Math.min(100, percentage));
                progressBar.style.width = `${percentage}%`;
                progressBar.setAttribute('aria-valuenow', percentage);
                progressBar.textContent = text || `${percentage}%`;
            };

            const setCrawlActive = (isActive) => {
                startBtn.disabled = isActive;
                stopBtn.disabled = !isActive;
                if (isActive) {
                    progressBar.classList.add('progress-bar-animated');
                    setProgress(0, '0%');
                } else {
                    progressBar.classList.remove('progress-bar-animated');
                }
            };

            const updateDeleteButtonState = () => {
                const checkedCheckboxes = document.querySelectorAll('.paper-checkbox:checked');
                deleteSelectedBtn.disabled = checkedCheckboxes.length === 0;
            };

            const deletePapers = async (paperIds) => {
                if (!confirm(`确定要删除 ${paperIds.length} 篇论文吗？这将同时删除本地文件。`)) {
                    return;
                }
                try {
                    const response = await fetch('/api/papers/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ paper_ids: paperIds })
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        addLog(`成功删除 ${result.message}`, 'success');
                        // Remove deleted papers from allPapers array
                        allPapers = allPapers.filter(paper => !paperIds.includes(paper.id));
                        filterPapers(); // Re-render the table
                        updateDeleteButtonState(); // Update button state
                        selectAllPapersCheckbox.checked = false; // Uncheck select all
                    } else {
                        addLog(`删除失败: ${result.message}`, 'danger');
                    }
                } catch (error) {
                    addLog('删除论文失败，请检查后端日志。', 'danger');
                    console.error(error);
                }
            };

            const renderPaperRow = (paper) => {
                const row = document.createElement('tr');
                row.setAttribute('data-paper-id', paper.id); // Add data attribute for paper ID
                row.innerHTML = `
                    <td><input type="checkbox" class="paper-checkbox" value="${paper.id}"></td> <!-- New checkbox column -->
                    <td><a href="${paper.paper_url}" target="_blank" title="${paper.title}">${paper.title.substring(0, 60)}...</a></td>
                    <td><small class="text-muted">${paper.authors.substring(0, 40)}...</small></td>
                    <td><span class="badge bg-${paper.source === 'arXiv' ? 'primary' : 'success'}">${paper.source}</span></td>
                    <td><small class="text-muted">${paper.category.split(',')[0]}</small></td>
                    <td>${new Date(paper.download_date).toLocaleDateString()}</td>
                    <td>
                        ${paper.filepath ?
                            `<a href="/paper_files/${paper.filepath}" target="_blank" class="btn btn-sm btn-outline-secondary" title="下载PDF"><i class="bi bi-file-earmark-pdf"></i> PDF</a>` :
                            `<a href="${paper.paper_url}" target="_blank" class="btn btn-sm btn-outline-info" title="查看原文"><i class="bi bi-box-arrow-up-right"></i> Link</a>`
                        }
                    </td>
                `;
                return row;
            };

            const toggleModeInputs = () => {
                const mode = modeSelect.value;
                if (mode === 'category') {
                    keywordsGroup.style.display = 'none';
                    arxivMaxResultsKwGroup.style.display = 'none';
                    biorxivDaysAgoGroup.style.display = 'none';

                    arxivCatsGroup.style.display = 'block';
                    biorxivCatsGroup.style.display = 'block';
                    arxivMaxResultsCatGroup.style.display = 'block';
                    categoryFetchDaysAgoGroup.style.display = 'block';
                } else if (mode === 'keyword') {
                    keywordsGroup.style.display = 'block';
                    arxivMaxResultsKwGroup.style.display = 'block';
                    biorxivDaysAgoGroup.style.display = 'block';

                    arxivCatsGroup.style.display = 'none';
                    biorxivCatsGroup.style.display = 'none';
                    arxivMaxResultsCatGroup.style.display = 'none';
                    categoryFetchDaysAgoGroup.style.display = 'none';
                }
            };

            const filterPapers = () => {
                const selectedCategory = categoryFilterSelect.value;
                papersTableBody.innerHTML = ''; // Clear current table

                const filteredPapers = allPapers.filter(paper => {
                    if (selectedCategory === '') {
                        return true; // Show all if no category selected
                    } else {
                        // Check if the paper's category (or any of its categories if multiple) matches the selected one
                        return paper.category.split(',').some(cat => cat.trim() === selectedCategory);
                    }
                });

                filteredPapers.forEach(paper => papersTableBody.appendChild(renderPaperRow(paper)));
            };

            // --- API Calls ---
            const loadCategories = async () => {
                try {
                    const response = await fetch('/api/categories');
                    const data = await response.json();

                    // Populate arXiv categories with checkboxes
                    arxivCatsCheckboxes.innerHTML = '';
                    data.arxiv.forEach(group => {
                        const optgroupLabel = document.createElement('div');
                        optgroupLabel.className = 'fw-bold mt-2';
                        optgroupLabel.textContent = group.group;
                        arxivCatsCheckboxes.appendChild(optgroupLabel);

                        group.categories.forEach(cat => {
                            const div = document.createElement('div');
                            div.className = 'form-check';
                            div.innerHTML = `
                                <input class="form-check-input" type="checkbox" value="${cat.code}" id="arxiv-${cat.code}">
                                <label class="form-check-label" for="arxiv-${cat.code}">
                                    ${cat.name} (${cat.code})
                                </label>
                            `;
                            arxivCatsCheckboxes.appendChild(div);
                        });
                    });

                    // Populate bioRxiv categories with checkboxes
                    biorxivCatsCheckboxes.innerHTML = '';
                    data.biorxiv.forEach(cat => {
                        const div = document.createElement('div');
                        div.className = 'form-check';
                        div.innerHTML = `
                            <input class="form-check-input" type="checkbox" value="${cat}" id="biorxiv-${cat.replace(/\s/g, '')}">
                            <label class="form-check-label" for="biorxiv-${cat.replace(/\s/g, '')}">
                                ${cat}
                            </label>
                        `;
                        biorxivCatsCheckboxes.appendChild(div);
                    });

                    // Populate category filter select
                    categoryFilterSelect.innerHTML = '<option value="">所有类别</option>';
                    const uniqueCategories = new Set();
                    data.arxiv.forEach(group => {
                        group.categories.forEach(cat => uniqueCategories.add(cat.code));
                    });
                    data.biorxiv.forEach(cat => uniqueCategories.add(cat));

                    Array.from(uniqueCategories).sort().forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        categoryFilterSelect.appendChild(option);
                    });

                    addLog('分类列表加载成功。', 'success');
                } catch (error) {
                    addLog('加载分类列表失败。', 'danger');
                    console.error(error);
                }
            };

            const loadConfig = async () => {
                try {
                    const response = await fetch('/api/config');
                    const configData = await response.json();
                    const state = { config: configData }; 

                    keywordsInput.value = (state.config.keywords || []).join('\n');
                    
                    // Set checked state for arXiv checkboxes
                    const arxivValues = (state.config.categories.arxiv || []).map(val => val.toLowerCase());
                    arxivCatsCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = arxivValues.includes(checkbox.value.toLowerCase());
                    });

                    // Set checked state for bioRxiv checkboxes
                    const biorxivValues = (state.config.categories.biorxiv || []).map(val => val.toLowerCase());
                    biorxivCatsCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = biorxivValues.includes(checkbox.value.toLowerCase());
                    });
                    
                    // Set fetch settings values
                    document.getElementById('arxiv-max-results-kw-input').value = state.config.fetch_settings.arxiv_max_results_kw || 100;
                    document.getElementById('biorxiv-days-ago-input').value = state.config.fetch_settings.biorxiv_days_ago || 7;
                    document.getElementById('arxiv-max-results-cat-input').value = state.config.fetch_settings.arxiv_max_results_cat || 50;
                    document.getElementById('category-fetch-days-ago-input').value = state.config.fetch_settings.category_fetch_days_ago || 7;

                    addLog('配置加载成功。', 'success');
                } catch (error) {
                    addLog('加载配置失败。', 'danger');
                    console.error(error);
                }
            };

            const loadPapers = async () => {
                try {
                    const response = await fetch('/api/papers');
                    const papers = await response.json();
                    allPapers = papers; // Store all papers
                    filterPapers(); // Apply initial filter (show all)
                    addLog(`已加载 ${papers.length} 条已下载论文记录。`, 'info');

                    // Populate category filter select with categories from loaded papers
                    const uniqueCategoriesFromPapers = new Set();
                    allPapers.forEach(paper => {
                        // Split by comma and add each category
                        paper.category.split(',').forEach(cat => uniqueCategoriesFromPapers.add(cat.trim()));
                    });

                    categoryFilterSelect.innerHTML = '<option value="">所有类别</option>';
                    Array.from(uniqueCategoriesFromPapers).sort().forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        categoryFilterSelect.appendChild(option);
                    });

                } catch (error) {
                    addLog('加载论文列表失败。', 'danger');
                    console.error(error);
                }
            };

            // --- Socket.IO Event Handlers ---
            socket.on('connect', async () => {
                addLog('成功连接到服务器！', 'success');
                await loadCategories(); // Wait for categories to load first
                await loadConfig();
                await loadPapers();
                toggleModeInputs(); // Initial toggle based on default mode
            });

            socket.on('status_update', (data) => {
                addLog(data.status, 'info');
            });

            socket.on('progress_update', (data) => {
                setProgress(data.progress, data.status);
            });

            socket.on('paper_downloaded', (data) => {
                addLog(`新论文已下载: ${data.paper.title}`, 'success');
                // Add new paper to allPapers and re-filter
                allPapers.unshift(data.paper); // Add to the beginning
                filterPapers();
                // Re-populate category filter select with categories from updated allPapers
                const uniqueCategoriesFromPapers = new Set();
                allPapers.forEach(paper => {
                    paper.category.split(',').forEach(cat => uniqueCategoriesFromPapers.add(cat.trim()));
                });

                categoryFilterSelect.innerHTML = '<option value="">所有类别</option>';
                Array.from(uniqueCategoriesFromPapers).sort().forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    categoryFilterSelect.appendChild(option);
                });
            });

            socket.on('crawl_finished', () => {
                setCrawlActive(false);
                setProgress(100, '完成');
            });

            // --- UI Event Listeners ---
            startBtn.addEventListener('click', () => {
                const mode = modeSelect.value;
                const getCheckedValues = (container) => Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(checkbox => checkbox.value);

                const selectedArxivCategories = getCheckedValues(arxivCatsCheckboxes);
                const selectedBiorxivCategories = getCheckedValues(biorxivCatsCheckboxes);
                
                socket.emit('start_crawl', { 
                    mode: mode,
                    categories: {
                        arxiv: selectedArxivCategories,
                        biorxiv: selectedBiorxivCategories
                    }
                });
                setCrawlActive(true);
                addLog(`请求开始抓取，模式: ${mode}`, 'warning');
            });

            stopBtn.addEventListener('click', () => {
                socket.emit('stop_crawl');
                addLog('请求停止抓取... ', 'warning');
            });

            saveConfigBtn.addEventListener('click', async () => {
                const getCheckedValues = (container) => Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(checkbox => checkbox.value);
                
                const newConfig = {
                    keywords: keywordsInput.value.split('\n').filter(k => k.trim()),
                    categories: {
                        arxiv: getCheckedValues(arxivCatsCheckboxes),
                        biorxiv: getCheckedValues(biorxivCatsCheckboxes),
                    },
                    fetch_settings: {
                        arxiv_max_results_kw: parseInt(document.getElementById('arxiv-max-results-kw-input').value) || 100,
                        biorxiv_days_ago: parseInt(document.getElementById('biorxiv-days-ago-input').value) || 7,
                        arxiv_max_results_cat: parseInt(document.getElementById('arxiv-max-results-cat-input').value) || 50,
                        category_fetch_days_ago: parseInt(document.getElementById('category-fetch-days-ago-input').value) || 7,
                    }
                };
                try {
                    const response = await fetch('/api/config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newConfig)
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        addLog('配置保存成功！', 'success');
                    } else {
                        addLog(`配置保存失败: ${result.message}`, 'danger');
                    }
                } catch (error) {
                    addLog('配置保存失败，请检查后端日志。', 'danger');
                    console.error(error);
                }
            });

            modeSelect.addEventListener('change', toggleModeInputs);
            categoryFilterSelect.addEventListener('change', filterPapers);

            // Select All checkbox
            selectAllPapersCheckbox.addEventListener('change', () => {
                const isChecked = selectAllPapersCheckbox.checked;
                document.querySelectorAll('.paper-checkbox').forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
                updateDeleteButtonState();
            });

            // Individual paper checkbox
            papersTableBody.addEventListener('change', (event) => {
                if (event.target.classList.contains('paper-checkbox')) {
                    updateDeleteButtonState();
                    // If any checkbox is unchecked, uncheck "select all"
                    if (!event.target.checked) {
                        selectAllPapersCheckbox.checked = false;
                    } else {
                        // If all are checked, check "select all"
                        const allCheckboxes = document.querySelectorAll('.paper-checkbox');
                        const checkedCheckboxes = document.querySelectorAll('.paper-checkbox:checked');
                        if (allCheckboxes.length === checkedCheckboxes.length) {
                            selectAllPapersCheckbox.checked = true;
                        }
                    }
                }
            });

            // Delete Selected button
            deleteSelectedBtn.addEventListener('click', () => {
                const selectedPaperIds = Array.from(document.querySelectorAll('.paper-checkbox:checked')).map(checkbox => parseInt(checkbox.value));
                if (selectedPaperIds.length > 0) {
                    deletePapers(selectedPaperIds);
                } else {
                    addLog('请选择要删除的论文。', 'warning');
                }
            });

            // Delete All button
            deleteAllBtn.addEventListener('click', () => {
                const allPaperIds = allPapers.map(paper => paper.id);
                if (allPaperIds.length > 0) {
                    deletePapers(allPaperIds);
                } else {
                    addLog('没有论文可供删除。', 'warning');
                }
            });
        });
    </script>
</body>
</html>